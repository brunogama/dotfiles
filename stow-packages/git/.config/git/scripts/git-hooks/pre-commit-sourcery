#!/usr/bin/env bash

source ${HOME}/.config/bin/prints
pgreen "Starting ${BLUE}${0}"
$HOME/.config/bin/check-dependency sourcery

# # Check if sourcery.yml exists in the root directory
# if [ ! -f "sourcery.yml" ] && [ ! -f ".sourcery.yml" ]; then
#     echo -e "${YELLOW}No sourcery configuration file found. Skipping.${NC}"
#     exit 0
# fi

# Get the configuration file
CONFIG_FILE="sourcery.yml"
if [ -f ".sourcery.yml" ]; then
    CONFIG_FILE=".sourcery.yml"
fi

if sourcery --config "$CONFIG_FILE"; then
    # Check if any files were generated/modified
    if git diff --quiet; then
        psuccess "No changes from Sourcery"
    else
        pwarning "Sourcery generated new code. Adding changes to commit..."
        GENERATED_FILES=$(git diff --name-only | grep -E '(Generated|\.generated\.swift$|AutoGenerated)')
        if [ -n "$GENERATED_FILES" ]; then
            git add $GENERATED_FILES
            psuccess "Added generated files to commits"
        fi
    fi
else
    perror "Sourcery failed to run"
    exit 1
fi

psuccess "${0} Finished execution with success"
exit 0