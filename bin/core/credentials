#! /usr/bin/env bash

set -euo pipefail

# Usage function
usage() {
    cat << EOF
Usage: $0 [pf|pj] [OPTIONS]

CREDENTIAL TYPES:
    pf              Use integrity environment
    pj              Use integrityPJ environment

ENVIRONMENT OPTIONS:
    -p, --production    Set production environment
    -s, --staging       Set staging environment
    -d, --development   Set development environment

EXAMPLES:
    $0 pf --production      # PF with production credentials
    $0 pj -s                # PJ with staging credentials
    $0 pf                   # PF with interactive prompt

EOF
}

# Check for help flag first
if [[ $# -gt 0 ]] && [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
    exit 0
fi

# Validate first parameter
if [[ $# -eq 0 ]]; then
    echo "Error: Missing required parameter" >&2
    usage
    exit 1
fi

# Parse credential type
CREDENTIAL_TYPE="$1"
shift

if [[ "$CREDENTIAL_TYPE" != "pf" && "$CREDENTIAL_TYPE" != "pj" ]]; then
    echo "Error: Invalid credential type '$CREDENTIAL_TYPE'" >&2
    usage
    exit 1
fi

# Set credential scope based on type
if [[ "$CREDENTIAL_TYPE" == "pf" ]]; then
    export CREDENTIALS_SCOPE="inter"
    export APP_IDENTIFIERS_ENV="integrity"
    export APP_ENV="inter"
else
    export CREDENTIALS_SCOPE="interPFJ"
    export APP_IDENTIFIERS_ENV="integrityPJ"
    export APP_ENV="interPFJ"
fi

# Parse environment flag
CREDENTIALS_ENV=""

if [[ $# -gt 0 ]]; then
    case "$1" in
        -p|--production)
            CREDENTIALS_ENV="production"
            shift
            ;;
        -s|--staging)
            CREDENTIALS_ENV="staging"
            shift
            ;;
        -d|--development)
            CREDENTIALS_ENV="development"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Error: Invalid option '$1'" >&2
            usage
            exit 1
            ;;
    esac
    
    # Check for extra arguments
    if [[ $# -gt 0 ]]; then
        echo "Error: Unexpected extra argument(s): $*" >&2
        usage
        exit 1
    fi
fi

# Interactive prompt if no environment flag provided
if [[ -z "$CREDENTIALS_ENV" ]]; then
    while true; do
        read -p "Qual é o ambiente? [s]taging, [d]evelopment, [p]roduction: " -n 1 -r
        echo
        case $REPLY in
            [sS])
                CREDENTIALS_ENV="staging"
                break
                ;;
            [dD])
                CREDENTIALS_ENV="development"
                break
                ;;
            [pP])
                CREDENTIALS_ENV="production"
                break
                ;;
            *)
                echo "Opção inválida. Por favor, insira 's', 'd' ou 'p'."
                ;;
        esac
    done
fi

export CREDENTIALS_ENV

# Verify fastlane is available
if ! command -v fastlane &> /dev/null; then
    echo "Error: fastlane command not found" >&2
    echo "Please install fastlane: gem install fastlane" >&2
    exit 1
fi

echo "Executando: fastlane set_credentials com CREDENTIALS_ENV=${CREDENTIALS_ENV}"
fastlane set_credentials "env:${CREDENTIALS_ENV}"