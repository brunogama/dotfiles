#!/bin/bash
#
# dump-api-keys - Export API keys from macOS Keychain as environment variables
# Usage:
#   eval $(dump-api-keys)           # Load all API keys into environment
#   dump-api-keys > keys.env        # Save to file for sourcing
#   dump-api-keys --pattern FOO     # Only dump keys containing FOO
#
# This script exports all API keys (service names ending with _KEY)
# that were stored using the store-api-key script.

set -euo pipefail

# Script name for error messages
readonly SCRIPT_NAME="$(basename "$0")"

# Default pattern matches all keys ending with _KEY
PATTERN=".*API_KEY$"
SAFE_MODE=false

# Function to display usage information
usage() {
    cat << EOF
Usage: $SCRIPT_NAME [OPTIONS]

Export API keys from macOS Keychain as environment variables.

Options:
  -p, --pattern PATTERN   Only export keys matching PATTERN (regex)
  -s, --safe              Generate a sourceable file instead of eval-ready output
  -h, --help              Show this help message

Examples:
  # Load all API keys into current shell
  eval \$($SCRIPT_NAME)

  # Save to file and source it (safer)
  $SCRIPT_NAME > ~/.api-keys.env
  source ~/.api-keys.env

  # Only export keys containing "AWS"
  eval \$($SCRIPT_NAME --pattern AWS)

  # Export in safe mode (with instructions)
  $SCRIPT_NAME --safe > api-keys.sh

Security Note:
  Using eval is convenient but can be dangerous. Consider using the
  file-based approach (saving to a file and sourcing it) for better security.
EOF
    exit 0
}

# Function to display error messages
error() {
    echo "Error: $1" >&2
    exit "${2:-1}"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -p|--pattern)
            PATTERN="$2"
            shift 2
            ;;
        -s|--safe)
            SAFE_MODE=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            error "Unknown option: $1" 1
            ;;
    esac
done

# Check if running on macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    error "This script requires macOS" 2
fi

# Check if security command is available
if ! command -v security &> /dev/null; then
    error "The 'security' command is not available" 2
fi

# Function to get all API key service names from keychain
get_api_key_services() {
    # Dump keychain and extract service names
    # The dump-keychain output includes lines like: "svce"<blob>="SERVICE_NAME"
    security dump-keychain 2>/dev/null | \
        awk -F'"' '/"svce"<blob>=/ && $4 ~ /'"$PATTERN"'/ {print $4}' | \
        sort -u || true
}

# Function to escape a value for safe shell usage
escape_value() {
    printf '%q' "$1"
}

# Header for safe mode
if [[ "$SAFE_MODE" == "true" ]]; then
    cat << 'EOF'
#!/bin/bash
# Generated by dump-api-keys
# Source this file to load API keys into your environment
# Usage: source this_file.sh

EOF
fi

# Get list of API key services
services=$(get_api_key_services)

if [[ -z "$services" ]]; then
    if [[ "$SAFE_MODE" == "true" ]]; then
        echo "# No API keys found matching pattern: $PATTERN" >&2
    else
        echo "# No API keys found matching pattern: $PATTERN" >&2
    fi
    exit 0
fi

# Export count for reporting
count=0

# Process each service
while IFS= read -r service; do
    # Skip empty lines
    [[ -z "$service" ]] && continue

    # Validate service name (alphanumeric, underscore, dash only)
    if ! [[ "$service" =~ ^[A-Za-z0-9_-]+$ ]]; then
        echo "# Warning: Skipping invalid service name: $service" >&2
        continue
    fi

    # Retrieve the API key value
    if api_key=$(security find-generic-password -a "$USER" -s "$service" -w 2>/dev/null); then
        # Escape the value for safe shell usage
        escaped_value=$(escape_value "$api_key")

        # Output the export statement
        echo "export $service=$escaped_value"
        ((count++))
    else
        echo "# Warning: Could not retrieve key for: $service" >&2
    fi
done <<< "$services"

# Summary in safe mode
if [[ "$SAFE_MODE" == "true" ]]; then
    echo ""
    echo "# Exported $count API keys"
fi

# If no keys were exported successfully
if [[ $count -eq 0 ]]; then
    echo "# No API keys could be retrieved" >&2
    exit 1
fi
